fullname: Start containers
description: Start containers so that you can develop right away.

dependencies:
- rpm: [docker, vagrant]

args:
  path:
    use: common_args

  recreate:
    flags: [-r, --recreate]
    help: Recreate Docker containers (and images, if needed) before running.
    action: store_true
    default: False

  keep_running:
    flags: [-k, --keep-running]
    help: Keep containers running at DevAssistant shutdown.
    action: store_true
    default: False

pre_run:
- if $path:
  - cl: cd $path
- dda_r: .

run:
- log_e: Unknow project type $project_type

run_djangopoc_django:
- docker_check_setup: ""

# first, stop running containers
- log_i: Stopping any previously created application containers ...
# ignore failures when halting, since containers may not be running at all
- vagrant_docker: halt

# rebuild images if requested
- if $recreate:
  - log_i: Destroying any previously built docker images and created containers ...
  - vagrant_docker: destroy -f
  - log_i: Recreating Docker images, this will take a while ...
  # this seem to not actually rebuild images because of
  #  https://github.com/mitchellh/vagrant/issues/3055
  - vagrant_docker: reload --provision

- log_i: Starting application containers ...
- if not $recreate:
  - log_i: If this is the first time you're running this assistant, Docker images will be built.
  - log_i: This might take a while ...
- $containers~:
  - vagrant_docker: up

- log_i: You can now go to http://localhost to see your running application.

- $containers_nice: ""
- for $c in $containers:
  - $containers_nice: "$containers_nice, $c"
  # register containers for shutdown
  - if not $keep_running:
    - atexit:
      - log_i: Stopping container $c ...
      - docker_stop: $c

# attach to containers' output
- log_i: "Attaching to output of containers: $containers_nice ..."
- log_i: "Hit Ctrl+C any time to interrupt on command line."
- log_i: "This is uninterruptible in GUI for now, sorry :("
- docker_attach: $containers
